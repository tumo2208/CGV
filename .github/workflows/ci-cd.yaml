name: CI/CD Backend to Cloud Run
on:
  push:
    branches: [ "main" ]
    paths:
      - "backend/**"
      - ".github/workflows/**"

jobs:
  deploy:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # âœ… Configure Docker to use GCR
      - name: Configure Docker
        run: gcloud auth configure-docker

      # ðŸ”¨ Build image báº±ng Docker
      - name: Build Docker Image
        run: |
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/spring-backend .

      # ðŸ“¤ Push image lÃªn GCR
      - name: Push to GCR
        run: |
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/spring-backend

      # ðŸš€ Deploy Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy spring-backend \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/spring-backend \
            --platform managed \
            --region asia-east1 \
            --allow-unauthenticated \
            --service-account cgv-732@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --add-cloudsql-instances ${{ secrets.CLOUDSQL_INSTANCE }} \
            --set-env-vars "SPRING_CLOUD_GCP_SQL_DATABASE_NAME=${{ secrets.DB_NAME }}" \
            --set-env-vars "SPRING_CLOUD_GCP_SQL_INSTANCE_CONNECTION_NAME=${{ secrets.CLOUDSQL_INSTANCE }}" \
            --set-env-vars "SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USER }}" \
            --set-env-vars "SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}" \
            --set-env-vars "JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            --set-env-vars "REDIS_URL=${{ secrets.REDIS_URL }}" \
            --set-env-vars "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" \
            --set-env-vars "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" \
            --set-env-vars "GCP_BUCKET_NAME=${{ secrets.GCP_BUCKET_NAME }}" \
            --set-env-vars "EMAIL_USERNAME=${{ secrets.EMAIL_USERNAME }}" \
            --set-env-vars "EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}" \
            --set-env-vars "APP_FRONTEND_URL=${{ secrets.APP_FRONTEND_URL }}" \
            --set-env-vars "VNPAY_URL=${{ secrets.VNPAY_URL }}" \
            --set-env-vars "VNPAY_RETURN_URL=${{ secrets.VNPAY_RETURN_URL }}" \
            --set-env-vars "VNPAY_TMN_CODE=${{ secrets.VNPAY_TMN_CODE }}" \
            --set-env-vars "VNPAY_SECRET_KEY=${{ secrets.VNPAY_SECRET_KEY }}" \
            --set-env-vars "VNPAY_VERSION=2.1.0" \
            --set-env-vars "VNPAY_COMMAND=pay"
